<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QS Price Master - ExcelJS Edition</title>
    
    <!-- UI 樣式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 框架 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- ExcelJS: 支援下拉選單的強大 Excel 引擎 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- FileSaver: 用於保存檔案 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        [v-cloak] > * { display: none; }
        [v-cloak]::before {
            content: "System Loading...";
            display: block; text-align: center; padding-top: 50px; color: #64748b; font-weight: bold;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-base { @apply px-3 py-2 rounded-md transition shadow-sm font-medium text-sm flex items-center justify-center gap-2 cursor-pointer select-none; }
        .btn-primary { @apply bg-slate-900 text-white hover:bg-slate-800; }
        .btn-secondary { @apply bg-white border border-slate-300 text-slate-700 hover:bg-slate-50; }
        .btn-icon-only { @apply p-2 rounded-md hover:bg-slate-100 text-slate-500 transition-colors; }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 min-h-screen pb-24">

    <div id="app" v-cloak class="max-w-7xl mx-auto min-h-screen bg-white shadow-xl flex flex-col border-x border-slate-200">
        
        <!-- 頂部導航 -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 md:px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-slate-900 text-white flex items-center justify-center rounded-lg font-bold text-lg flex-shrink-0">Q</div>
                <div class="leading-tight">
                    <h1 class="text-base font-bold text-slate-900">QS Price Master</h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold hidden md:block">ExcelJS Pro</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="openExportModal" class="btn-base btn-secondary">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span class="hidden md:inline">Export</span>
                </button>
                <label class="btn-base btn-secondary">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span class="hidden md:inline">Import</span>
                    <input type="file" @change="importData" accept=".xlsx,.xls" class="hidden">
                </label>
            </div>
        </header>

        <!-- 主要內容 -->
        <div class="p-4 md:p-8 flex-1 flex flex-col gap-6">
            
            <!-- 搜尋與過濾 -->
            <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-1 relative group">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input v-model="searchQuery" type="text" placeholder="Search description..." 
                        class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-md focus:ring-1 focus:ring-slate-900 focus:border-slate-900 outline-none transition text-sm">
                </div>
                <select v-model="filterCategory" class="p-2.5 bg-slate-50 border border-slate-200 rounded-md outline-none text-sm w-full md:w-48 cursor-pointer h-[42px]">
                    <option value="">All Trades</option>
                    <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                </select>
            </div>

            <!-- 統計看板 -->
            <div v-if="filteredItems.length > 0 && searchQuery" class="bg-slate-50 border border-slate-200 rounded-lg p-4 animate-fade-in">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="text-slate-500 w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wide">Analysis: {{ searchQuery }}</h3>
                </div>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-white p-2 md:p-3 rounded border border-slate-100 shadow-sm">
                        <div class="text-[10px] text-slate-400 uppercase font-semibold">Avg</div>
                        <div class="text-base md:text-lg font-bold text-slate-800">${{ formatNumber(stats.avg) }}</div>
                    </div>
                    <div class="bg-white p-2 md:p-3 rounded border border-slate-100 shadow-sm">
                        <div class="text-[10px] text-slate-400 uppercase font-semibold">Min</div>
                        <div class="text-base md:text-lg font-bold text-emerald-600">${{ formatNumber(stats.min) }}</div>
                    </div>
                    <div class="bg-white p-2 md:p-3 rounded border border-slate-100 shadow-sm">
                        <div class="text-[10px] text-slate-400 uppercase font-semibold">Max</div>
                        <div class="text-base md:text-lg font-bold text-rose-600">${{ formatNumber(stats.max) }}</div>
                    </div>
                </div>
            </div>

            <!-- 數據表格 -->
            <div class="overflow-x-auto bg-white border border-slate-200 rounded-lg shadow-sm">
                <table class="w-full text-left text-sm min-w-[600px]">
                    <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                        <tr>
                            <th class="p-4 w-[40%]">Description</th>
                            <th class="p-4 w-[15%]">Trade</th>
                            <th class="p-4 w-[10%]">Unit</th>
                            <th class="p-4 w-[15%] text-right">Rate (HK$)</th>
                            <th class="p-4 w-[15%]">Date</th>
                            <th class="p-4 w-[5%] text-center"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr v-for="(item, index) in filteredItems" :key="item.id" class="hover:bg-slate-50 transition group">
                            <td class="p-4 align-top">
                                <div class="font-medium text-slate-900 break-words">{{ item.desc }}</div>
                                <div v-if="item.project" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-blue-50 text-blue-600 border border-blue-100 truncate max-w-[200px]">
                                        {{ item.project }}
                                    </span>
                                </div>
                            </td>
                            <td class="p-4 align-top">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-slate-100 text-slate-600 border border-slate-200">
                                    {{ item.category }}
                                </span>
                            </td>
                            <td class="p-4 align-top">
                                <span class="font-mono text-xs text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded">{{ item.unit }}</span>
                            </td>
                            <td class="p-4 align-top text-right font-mono font-medium text-slate-900">
                                {{ formatNumber(item.rate) }}
                            </td>
                            <td class="p-4 align-top text-slate-500 text-xs font-mono whitespace-nowrap">{{ item.date }}</td>
                            <td class="p-4 align-top text-center">
                                <button @click="deleteItem(item.id)" class="btn-icon-only text-slate-300 hover:text-rose-500" title="Delete">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </td>
                        </tr>
                        <tr v-if="filteredItems.length === 0">
                            <td colspan="6" class="p-12 text-center text-slate-400">
                                <span class="text-sm">No records found.</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="text-center text-xs text-slate-400 font-mono mt-4">
                Total Records: {{ items.length }}
            </div>
        </div>

        <!-- 浮動新增按鈕 -->
        <button @click="openAddModal" class="fixed bottom-8 right-8 bg-slate-900 hover:bg-slate-800 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition transform active:scale-95 z-40 group">
            <svg class="w-6 h-6 group-hover:rotate-90 transition duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>

        <!-- 新增數據 Modal -->
        <div v-if="showModal" class="fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-lg shadow-2xl p-6 animate-fade-in max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4 sticky top-0 bg-white z-10">
                    <h2 class="text-lg font-bold text-slate-800">New Record</h2>
                    <button @click="showModal = false" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Description *</label>
                        <input v-model="form.desc" type="text" class="w-full p-2.5 bg-slate-50 rounded border border-slate-200 focus:border-slate-900 focus:ring-0 outline-none transition text-sm" placeholder="e.g. C35/20 Concrete">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Trade</label>
                            <select v-model="form.category" class="w-full p-2.5 bg-slate-50 rounded border border-slate-200 outline-none text-sm h-[42px]">
                                <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Unit</label>
                            <input v-model="form.unit" list="units" type="text" class="w-full p-2.5 bg-slate-50 rounded border border-slate-200 outline-none text-sm" placeholder="m2">
                            <datalist id="units"><option value="m"><option value="m2"><option value="m3"><option value="kg"><option value="t"><option value="nr"><option value="item"></datalist>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Rate (HK$) *</label>
                            <input v-model.number="form.rate" type="number" class="w-full p-2.5 bg-slate-50 rounded border border-slate-200 outline-none font-mono text-sm" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Date</label>
                            <input v-model="form.date" type="date" class="w-full p-2.5 bg-slate-50 rounded border border-slate-200 outline-none text-sm h-[42px]">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Project Name</label>
                        <input v-model="form.project" type="text" class="w-full p-2.5 bg-slate-50 rounded border border-slate-200 outline-none text-sm" placeholder="e.g. Kai Tak Residential">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Supplier (Optional)</label>
                        <input v-model="form.supplier" type="text" class="w-full p-2.5 bg-slate-50 rounded border border-slate-200 outline-none text-sm" placeholder="e.g. Gammon">
                    </div>
                    <button @click="saveItem" class="w-full btn-base btn-primary py-3 mt-2">Save Record</button>
                </div>
            </div>
        </div>

        <!-- 導出設定 Modal -->
        <div v-if="showExportModalState" class="fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-lg shadow-2xl p-6 animate-fade-in max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Export Excel</h2>
                        <p class="text-xs text-slate-500">Drag arrows to reorder columns</p>
                    </div>
                    <button @click="showExportModalState = false" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                <div class="space-y-2 mb-6 overflow-y-auto flex-1 pr-2">
                    <div v-for="(col, idx) in exportColumns" :key="col.key" class="flex items-center justify-between bg-slate-50 p-3 rounded border border-slate-200">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" v-model="col.active" class="w-4 h-4 rounded border-slate-300 text-slate-900 focus:ring-slate-900 cursor-pointer">
                            <span class="text-sm font-medium text-slate-700 select-none" :class="{'opacity-50': !col.active}">{{ col.label }}</span>
                        </div>
                        <div class="flex gap-1" v-if="col.active">
                            <button @click="moveColumn(idx, -1)" :disabled="idx === 0" class="p-1.5 hover:bg-slate-200 rounded disabled:opacity-30 transition">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                            </button>
                            <button @click="moveColumn(idx, 1)" :disabled="idx === exportColumns.length - 1" class="p-1.5 hover:bg-slate-200 rounded disabled:opacity-30 transition">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-auto">
                    <button @click="showExportModalState = false" class="flex-1 btn-base btn-secondary">Cancel</button>
                    <button @click="executeExport" class="flex-1 btn-base btn-primary">Download .xlsx</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const showModal = ref(false);
                const showExportModalState = ref(false);
                const items = ref([]);
                const searchQuery = ref("");
                const filterCategory = ref("");
                
                const exportColumns = ref([
                    { key: 'desc', label: 'Description', active: true, width: 40 },
                    { key: 'category', label: 'Trade', active: true, width: 20 },
                    { key: 'unit', label: 'Unit', active: true, width: 10 },
                    { key: 'rate', label: 'Rate', active: true, width: 15 },
                    { key: 'date', label: 'Date', active: true, width: 15 },
                    { key: 'project', label: 'Project', active: true, width: 25 },
                    { key: 'supplier', label: 'Supplier', active: true, width: 20 }
                ]);

                const categories = [
                    "Demolition", "Excavation", "Concreting", "Reinforcement", "Formwork", 
                    "Brickwork/Blockwork", "Waterproofing", "Roofing", "Woodwork", "Steel & Metal", 
                    "Plastering", "Tiling", "Painting", "Plumbing", "Electrical", "HVAC", "Preliminaries", "Other"
                ];

                const form = ref({
                    desc: "", category: "Concreting", unit: "m3", 
                    rate: "", date: new Date().toISOString().split('T')[0], 
                    project: "", supplier: ""
                });

                onMounted(() => {
                    try {
                        const savedData = localStorage.getItem('qs_price_db');
                        if (savedData) items.value = JSON.parse(savedData);
                        else items.value = [];
                    } catch (e) { console.error("Error loading data:", e); }
                });

                watch(items, (newVal) => {
                    localStorage.setItem('qs_price_db', JSON.stringify(newVal));
                }, { deep: true });

                const filteredItems = computed(() => {
                    return items.value.filter(item => {
                        const matchSearch = (item.desc || "").toLowerCase().includes(searchQuery.value.toLowerCase()) || 
                                          (item.project || "").toLowerCase().includes(searchQuery.value.toLowerCase());
                        const matchCat = filterCategory.value ? item.category === filterCategory.value : true;
                        return matchSearch && matchCat;
                    }).sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                const stats = computed(() => {
                    if (filteredItems.value.length === 0) return { avg: 0, min: 0, max: 0 };
                    const rates = filteredItems.value.map(i => Number(i.rate) || 0);
                    const sum = rates.reduce((a, b) => a + b, 0);
                    return {
                        avg: Math.round(sum / rates.length),
                        min: Math.min(...rates),
                        max: Math.max(...rates)
                    };
                });

                const openAddModal = () => {
                    form.value.desc = ""; form.value.rate = "";
                    showModal.value = true;
                };

                const saveItem = () => {
                    if (!form.value.desc || !form.value.rate) { alert("Please fill in Description and Rate."); return; }
                    items.value.unshift({ id: Date.now(), ...form.value });
                    showModal.value = false;
                };

                const deleteItem = (id) => {
                    if(confirm("Delete this record?")) items.value = items.value.filter(i => i.id !== id);
                };

                const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";

                const openExportModal = () => { showExportModalState.value = true; };

                const moveColumn = (index, direction) => {
                    const newIndex = index + direction;
                    if (newIndex >= 0 && newIndex < exportColumns.value.length) {
                        const temp = exportColumns.value[index];
                        exportColumns.value[index] = exportColumns.value[newIndex];
                        exportColumns.value[newIndex] = temp;
                    }
                };

                // --- 核心升級：使用 ExcelJS 進行匯出 ---
                const executeExport = async () => {
                    if (!window.ExcelJS) { alert("Excel engine loading..."); return; }

                    const workbook = new ExcelJS.Workbook();
                    workbook.creator = 'QS Price Master';
                    workbook.created = new Date();

                    // 1. 建立數據分頁
                    const sheet = workbook.addWorksheet('Price Data');
                    
                    // 2. 建立隱藏的列表分頁 (用於下拉選單)
                    const listSheet = workbook.addWorksheet('DataList', { state: 'hidden' });
                    categories.forEach((cat, index) => {
                        listSheet.getCell(`A${index + 1}`).value = cat;
                    });

                    // 3. 設定欄位標題與寬度
                    const activeCols = exportColumns.value.filter(c => c.active);
                    sheet.columns = activeCols.map(col => ({
                        header: col.label,
                        key: col.key,
                        width: col.width || 20
                    }));

                    // 4. 填入數據
                    filteredItems.value.forEach(item => {
                        const rowData = {};
                        activeCols.forEach(col => {
                            let val = item[col.key];
                            if (col.key === 'rate') val = parseFloat(val) || 0;
                            rowData[col.key] = val;
                        });
                        sheet.addRow(rowData);
                    });

                    // 5. 【關鍵】加入下拉選單驗證 (Data Validation)
                    // 找到 Trade 欄位的索引 (ExcelJS 欄位從 1 開始)
                    const tradeColIndex = activeCols.findIndex(c => c.label === 'Trade') + 1;
                    
                    if (tradeColIndex > 0) {
                        const colLetter = sheet.getColumn(tradeColIndex).letter;
                        // 為第 2 行到第 1000 行加入下拉選單 (預留空間給新資料)
                        for (let i = 2; i <= 1000; i++) {
                            sheet.getCell(`${colLetter}${i}`).dataValidation = {
                                type: 'list',
                                allowBlank: true,
                                formulae: [`'DataList'!$A$1:$A$${categories.length}`] // 引用隱藏分頁
                            };
                        }
                    }

                    // 6. 匯出檔案
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    saveAs(blob, `QS_Data_${new Date().toISOString().slice(0,10)}.xlsx`);
                    
                    showExportModalState.value = false;
                };

                // --- 核心升級：使用 ExcelJS 進行匯入 ---
                const importData = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const buffer = e.target.result;
                            const workbook = new ExcelJS.Workbook();
                            await workbook.xlsx.load(buffer);
                            
                            const worksheet = workbook.getWorksheet(1); // 讀取第一個分頁
                            if (!worksheet) return;

                            // 讀取標題列 (第一行)
                            const headerRow = [];
                            worksheet.getRow(1).eachCell((cell, colNumber) => {
                                headerRow[colNumber] = cell.value ? String(cell.value).toLowerCase().trim() : '';
                            });

                            const findIndex = (keys) => {
                                for (const key of keys) {
                                    const idx = headerRow.indexOf(key);
                                    if (idx !== -1) return idx;
                                }
                                return -1;
                            };

                            const map = {
                                desc: findIndex(['description', 'desc']),
                                category: findIndex(['trade', 'category']),
                                unit: findIndex(['unit']),
                                rate: findIndex(['rate', 'price']),
                                date: findIndex(['date']),
                                project: findIndex(['project']),
                                supplier: findIndex(['supplier'])
                            };

                            let newRecords = [];
                            worksheet.eachRow((row, rowNumber) => {
                                if (rowNumber === 1) return; // 跳過標題

                                const getVal = (key, defaultIdx) => {
                                    const idx = map[key];
                                    // ExcelJS 的 row.getCell(idx)
                                    // 注意：headerRow 陣列索引跟 ExcelJS 欄位索引可能差 1，需小心處理
                                    // 這裡我們直接用 map 存的是 headerRow 的 index (從 1 開始)
                                    let cell = (idx !== -1) ? row.getCell(idx) : row.getCell(defaultIdx);
                                    
                                    // 處理 Rich Text 或公式
                                    let val = cell.value;
                                    if (val && typeof val === 'object') {
                                        if (val.text) val = val.text; // Rich Text
                                        else if (val.result) val = val.result; // Formula
                                    }
                                    return val !== null && val !== undefined ? String(val).trim() : "";
                                };

                                let dateVal = getVal('date', 5);
                                // 簡單日期處理
                                if (!isNaN(dateVal) && Number(dateVal) > 10000) { 
                                    // 可能是 Excel Serial Date，這裡簡化處理，直接用當天
                                    // ExcelJS 其實會自動轉 Date 物件，如果是物件：
                                    const cellVal = row.getCell(map['date'] !== -1 ? map['date'] : 5).value;
                                    if (cellVal instanceof Date) {
                                        dateVal = cellVal.toISOString().split('T')[0];
                                    } else {
                                        dateVal = new Date().toISOString().split('T')[0];
                                    }
                                } else if (!dateVal) {
                                    dateVal = new Date().toISOString().split('T')[0];
                                }

                                newRecords.push({
                                    id: Date.now() + rowNumber,
                                    desc: getVal('desc', 1) || "Imported Item",
                                    category: getVal('category', 2) || "Other",
                                    unit: getVal('unit', 3) || "item",
                                    rate: parseFloat(getVal('rate', 4)) || 0,
                                    date: dateVal,
                                    project: getVal('project', 6) || "",
                                    supplier: getVal('supplier', 7) || ""
                                });
                            });

                            if (newRecords.length > 0 && confirm(`Found ${newRecords.length} records. Import?`)) {
                                items.value = [...newRecords, ...items.value];
                            }
                        } catch(err) {
                            console.error(err);
                            alert("Error reading file. Please check format.");
                        }
                        event.target.value = '';
                    };
                    reader.readAsArrayBuffer(file);
                };

                return {
                    showModal, showExportModalState, exportColumns,
                    items, form, categories, searchQuery, filterCategory,
                    filteredItems, stats,
                    openAddModal, saveItem, deleteItem, formatNumber, 
                    openExportModal, moveColumn, executeExport, importData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
