<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QS Price Master - Debug Mode</title>
    <!-- 改用全球通用 CDN -->
    <script src="https://unpkg.com/tailwindcss@^3/src/index.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* 注意：我移除了 v-cloak 的隱藏樣式，確保畫面一定會顯示 */
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* UI 元件樣式 - 使用標準 CSS 以防 Tailwind 沒載入 */
        .btn-base { padding: 8px 12px; border-radius: 6px; font-weight: 500; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: #0f172a; color: white; border: none; }
        .btn-secondary { background-color: white; border: 1px solid #cbd5e1; color: #334155; }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 min-h-screen pb-24">

    <!-- 移除了 v-cloak，現在一定看得到這個區塊 -->
    <div id="app" class="max-w-7xl mx-auto min-h-screen bg-white shadow-xl flex flex-col border-x border-slate-200">
        
        <!-- 頂部導航 -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 md:px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-slate-900 text-white flex items-center justify-center rounded-lg font-bold text-lg flex-shrink-0" style="background:#0f172a; color:white;">Q</div>
                <div class="leading-tight">
                    <h1 class="text-base font-bold text-slate-900">QS Price Master</h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold hidden md:block">Debug Version</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="openExportModal" class="btn-base btn-secondary">Export</button>
                <label class="btn-base btn-secondary">
                    Import
                    <input type="file" @change="importData" accept=".json,.csv" class="hidden" style="display:none;">
                </label>
            </div>
        </header>

        <!-- 主要內容 -->
        <div class="p-4 md:p-8 flex-1 flex flex-col gap-6">
            
            <!-- 搜尋與過濾區 -->
            <div class="flex flex-col md:flex-row gap-3" style="display:flex; gap:10px; margin-bottom: 20px;">
                <div class="flex-1 relative group" style="flex:1;">
                    <input v-model="searchQuery" type="text" placeholder="Search description..." 
                        class="w-full p-2 border rounded" style="width:100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                </div>
                <select v-model="filterCategory" class="p-2 border rounded" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                    <option value="">All Trades</option>
                    <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                </select>
            </div>

            <!-- 數據列表表格 -->
            <div class="overflow-x-auto bg-white border border-slate-200 rounded-lg shadow-sm">
                <table class="w-full text-left text-sm" style="width:100%; border-collapse: collapse;">
                    <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                        <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                            <th class="p-4 text-left">Description</th>
                            <th class="p-4 text-left">Unit</th>
                            <th class="p-4 text-right">Rate (HK$)</th>
                            <th class="p-4 text-left">Date</th>
                            <th class="p-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, index) in filteredItems" :key="item.id" style="border-bottom: 1px solid #f1f5f9;">
                            <td class="p-4">
                                <div class="font-medium">{{ item.desc }}</div>
                                <span style="font-size:10px; background:#f1f5f9; padding:2px 6px; border-radius:4px;">{{ item.category }}</span>
                            </td>
                            <td class="p-4">{{ item.unit }}</td>
                            <td class="p-4 text-right font-mono font-bold">{{ formatNumber(item.rate) }}</td>
                            <td class="p-4 text-slate-500">{{ item.date }}</td>
                            <td class="p-4 text-center">
                                <button @click="deleteItem(item.id)" style="color:red; cursor:pointer; border:none; background:none;">Del</button>
                            </td>
                        </tr>
                        <tr v-if="filteredItems.length === 0">
                            <td colspan="5" class="p-12 text-center text-slate-400" style="padding: 40px; text-align:center;">
                                No records found.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 浮動新增按鈕 -->
        <button @click="openAddModal" style="position:fixed; bottom:30px; right:30px; width:60px; height:60px; border-radius:50%; background:#0f172a; color:white; font-size:30px; border:none; cursor:pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">+</button>

        <!-- 新增數據 Modal -->
        <div v-if="showModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:50;">
            <div style="background:white; width:100%; max-width:500px; padding:24px; border-radius:12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                <h2 style="font-size:20px; font-weight:bold; margin-bottom:20px;">New Record</h2>
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <input v-model="form.desc" placeholder="Description (e.g. Concrete)" style="padding:10px; border:1px solid #ccc; rounded:6px; width:100%;">
                    <div style="display:flex; gap:10px;">
                        <select v-model="form.category" style="padding:10px; border:1px solid #ccc; flex:1;">
                            <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                        <input v-model="form.unit" placeholder="Unit" style="padding:10px; border:1px solid #ccc; width:80px;">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input v-model.number="form.rate" type="number" placeholder="Rate ($)" style="padding:10px; border:1px solid #ccc; flex:1;">
                        <input v-model="form.date" type="date" style="padding:10px; border:1px solid #ccc;">
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button @click="showModal = false" class="btn-base btn-secondary" style="flex:1; justify-content:center;">Cancel</button>
                        <button @click="saveItem" class="btn-base btn-primary" style="flex:1; justify-content:center;">Save</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // 錯誤捕捉：如果 Vue 沒載入，會彈出警告
        window.onerror = function(msg, url, line) {
            alert("Error detected: " + msg + "\nLine: " + line + "\n請確保你的網路可以連接到 unpkg.com");
        };

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const showModal = ref(false);
                const items = ref([]);
                const searchQuery = ref("");
                const filterCategory = ref("");
                
                const categories = [
                    "Demolition", "Excavation", "Concreting", "Reinforcement", "Formwork", 
                    "Brickwork/Blockwork", "Waterproofing", "Roofing", "Woodwork", "Steel & Metal", 
                    "Plastering", "Tiling", "Painting", "Plumbing", "Electrical", "HVAC", "Preliminaries", "Other"
                ];

                const form = ref({
                    desc: "", category: "Concreting", unit: "m3", 
                    rate: "", date: new Date().toISOString().split('T')[0], 
                    project: "", supplier: ""
                });

                onMounted(() => {
                    try {
                        const savedData = localStorage.getItem('qs_price_db');
                        if (savedData) items.value = JSON.parse(savedData);
                        else {
                            // 預設加入一筆資料，確認顯示正常
                            items.value = [{id: 1, desc: "Test Item (System Check)", category: "Other", unit: "item", rate: 100, date: "2024-01-01"}];
                        }
                    } catch(e) { console.error(e); }
                });

                watch(items, (newVal) => {
                    localStorage.setItem('qs_price_db', JSON.stringify(newVal));
                }, { deep: true });

                const filteredItems = computed(() => {
                    return items.value.filter(item => {
                        const matchSearch = (item.desc || "").toLowerCase().includes(searchQuery.value.toLowerCase());
                        const matchCat = filterCategory.value ? item.category === filterCategory.value : true;
                        return matchSearch && matchCat;
                    }).sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                const openAddModal = () => {
                    form.value.desc = ""; form.value.rate = "";
                    showModal.value = true;
                };

                const saveItem = () => {
                    if (!form.value.desc || !form.value.rate) { alert("Please fill in Description and Rate."); return; }
                    items.value.unshift({ id: Date.now(), ...form.value });
                    showModal.value = false;
                };

                const deleteItem = (id) => {
                    if(confirm("Delete this record?")) items.value = items.value.filter(i => i.id !== id);
                };

                const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";

                // 簡化版 Export/Import 功能 (為確保穩定性暫時簡化)
                const openExportModal = () => { alert("Export feature simplified in Debug Mode."); };
                const importData = () => { alert("Import feature simplified in Debug Mode."); };

                return {
                    showModal, items, form, categories, searchQuery, filterCategory,
                    filteredItems, openAddModal, saveItem, deleteItem, formatNumber, openExportModal, importData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
